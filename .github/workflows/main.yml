name: Main workflow

on: [push, pull_request]

jobs:
  download_version:
    name: Download the development version
    runs-on: ubuntu-latest
    outputs:
      development_version: ${{ steps.version_increment.outputs.dev_version }}
    steps:
    - name: Install the AWS command line interface
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version
    - name: Download the development version from the bucket
      run: aws s3 cp s3://anthem-workflows/main_workflow/$(echo "${{ github.repository }}" | tr - _)/dev_version.txt dev_version.txt
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
    - id: version_increment
      name: Create the development version
      run: |
        dev_version=`cat dev_version.txt`
        echo "The development version number downloaded from the S3 bucket is $dev_version"
        expr $dev_version + 1 > dev_version_current.txt
        dev_version_current=`cat dev_version_current.txt`
        echo "The development version number for the current run is $dev_version_current"
        echo "::set-output name=dev_version::$dev_version_current"
  
  set_version:
    name: Set the full version
    needs: [download_version]
    runs-on: ubuntu-latest
    env:
      ELEGY_DEVELOPMENT_VERSION_NUMBER: ${{ needs.download_version.outputs.development_version }}
    outputs:
      version: ${{ steps.create_version.outputs.version }}
    steps:
    - name: Check out the project
      uses: actions/checkout@v2.3.1
    - id: create_version
      name: Create the version
      run: echo "::set-output name=version::$(envsubst < ./util/version.txt)"

  build:
    name: Build
    needs: [download_version, set_version]
    runs-on: ubuntu-latest
    env:
      ELEGY_DEVELOPMENT_VERSION_NUMBER: ${{ needs.download_version.outputs.development_version }}
    steps:
    - name: Check out the project
      uses: actions/checkout@v2.3.1
    - name: Build the licence
      run: ./util/build
    - name: Upload build artefacts
      uses: actions/upload-artifact@v2
      with:
        name: effective-elegy-${{ needs.set_version.outputs.version }}
        path: dist/effective-elegy-*

  upload_version:
    name: Upload the development version
    needs: [download_version]
    runs-on: ubuntu-latest
    env:
      ELEGY_DEVELOPMENT_VERSION_NUMBER: ${{ needs.download_version.outputs.development_version }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
    steps:
    - name: Install the AWS command line interface
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version
    - name: Set the development version to the file
      run: |
        echo $ELEGY_DEVELOPMENT_VERSION_NUMBER > dev_version.txt
    - name: Delete the old development version from the bucket
      run: aws s3 rm s3://anthem-workflows/main_workflow/$(echo "${{ github.repository }}" | tr - _)/dev_version.txt
    - name: Upload the development version to the bucket
      run: aws s3 cp dev_version.txt s3://anthem-workflows/main_workflow/$(echo "${{ github.repository }}" | tr - _)/dev_version.txt
